// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Enums
enum Role {
  CUSTOMER
  ADMIN
}

enum OtpType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
}

enum AddressType {
  SHIPPING
  BILLING
}

enum ProductAvailability {
  IN_STOCK
  OUT_OF_STOCK
  PREORDER
  BACKORDER
}

enum ProductCondition {
  NEW
  REFURBISHED
  USED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCESS
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

// Models
model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  password      String? // Null for Google OAuth users
  emailVerified DateTime?
  image         String?
  role          Role      @default(CUSTOMER)
  phone         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts  Account[]
  cart      Cart?
  orders    Order[]
  addresses Address[]
  otpTokens OtpToken[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model OtpToken {
  id        String   @id @default(cuid())
  email     String
  token     String
  type      OtpType
  expiresAt DateTime
  createdAt DateTime @default(now())
  used      Boolean  @default(false)

  user User? @relation(fields: [email], references: [email], onDelete: Cascade)

  @@index([email, token])
}

model Address {
  id           String      @id @default(cuid())
  userId       String
  name         String
  phone        String
  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  pincode      String
  country      String      @default("India")
  isDefault    Boolean     @default(false)
  type         AddressType @default(SHIPPING)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders Order[]
}

model Category {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  image       String?
  parentId    String?
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Self-relation for subcategories
  parent   Category?  @relation("SubCategories", fields: [parentId], references: [id])
  children Category[] @relation("SubCategories")

  products Product[]
}

model Product {
  id String @id @default(cuid())

  // Basic Information
  title       String
  description String @db.Text
  link        String @unique // URL slug

  // Images
  imageLink            String // Primary image path
  additionalImageLinks String[] // Array of additional image paths

  // Pricing
  price                  Json // { value: number, currency: string }
  salePrice              Json? // { value: number, currency: string }
  salePriceEffectiveDate Json? // { startDate: DateTime, endDate: DateTime }

  // Availability & Stock
  availability  ProductAvailability @default(IN_STOCK)
  stockQuantity Int                 @default(0)

  // Identification
  sku   String  @unique
  mpn   String? // Manufacturer Part Number
  brand String?

  // Condition
  condition ProductCondition @default(NEW)

  // Category
  categoryId String

  // Product Information
  productDetails    Json[] // [{ sectionName, attributeName, attributeValue }]
  productHighlights String[] // Key features

  // Custom Labels (for filtering/organization)
  customLabel0 String?
  customLabel1 String?

  // Status
  isActive Boolean @default(true)
  isBundle Boolean @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  category   Category    @relation(fields: [categoryId], references: [id])
  cartItems  CartItem[]
  orderItems OrderItem[]

  @@index([categoryId])
  @@index([brand])
  @@index([availability])
  @@index([isActive])
}

model Cart {
  id        String   @id @default(cuid())
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  productId String
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId])
}

model Order {
  id          String      @id @default(cuid())
  orderNumber String      @unique
  userId      String
  addressId   String
  status      OrderStatus @default(PENDING)

  // Pricing
  subtotal     Decimal @db.Decimal(10, 2)
  shippingCost Decimal @default(0) @db.Decimal(10, 2)
  taxAmount    Decimal @default(0) @db.Decimal(10, 2)
  discount     Decimal @default(0) @db.Decimal(10, 2)
  totalAmount  Decimal @db.Decimal(10, 2)

  // Additional Info
  notes          String?
  trackingNumber String?
  trackingUrl    String?

  // Timestamps
  orderedAt   DateTime  @default(now())
  confirmedAt DateTime?
  processedAt DateTime?
  shippedAt   DateTime?
  deliveredAt DateTime?
  cancelledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user    User        @relation(fields: [userId], references: [id])
  address Address     @relation(fields: [addressId], references: [id])
  items   OrderItem[]
  payment Payment?

  @@index([userId])
  @@index([status])
  @@index([orderNumber])
}

model OrderItem {
  id              String   @id @default(cuid())
  orderId         String
  productId       String
  quantity        Int
  priceAtPurchase Decimal  @db.Decimal(10, 2)
  productSnapshot Json // Complete product details at time of purchase
  createdAt       DateTime @default(now())

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
}

model Payment {
  id      String @id @default(cuid())
  orderId String @unique

  // Razorpay Details
  razorpayOrderId   String  @unique
  razorpayPaymentId String?
  razorpaySignature String?

  // Payment Info
  amount        Decimal       @db.Decimal(10, 2)
  currency      String        @default("INR")
  status        PaymentStatus @default(PENDING)
  paymentMethod String? // card, upi, netbanking, wallet

  // Bank/Card Details (masked)
  bankName    String?
  cardLast4   String?
  cardNetwork String?
  vpa         String? // UPI VPA
  walletName  String?

  // Failure Details
  failureReason String?
  failureCode   String?

  // Timestamps
  paidAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  order Order @relation(fields: [orderId], references: [id])

  @@index([razorpayOrderId])
  @@index([status])
}
